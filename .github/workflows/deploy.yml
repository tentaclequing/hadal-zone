name: Build and Deploy

on:
  push:
    branches:
      - main

# Allow only one concurrent deployment, skipping runs queued between the
# current run and the latest queued.  Do NOT cancel in-progress runs so that
# IPFS pinning can complete.
concurrency:
  group: pages
  cancel-in-progress: false

permissions:
  contents: write   # needed for CID manifest commit
  pages: write
  id-token: write   # needed for Pages deployment

jobs:
  # -------------------------------------------------------------------
  # 1. Validate
  # -------------------------------------------------------------------
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Validate front matter
        run: node scripts/validate-frontmatter.js

  # -------------------------------------------------------------------
  # 2. Build
  # -------------------------------------------------------------------
  build:
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'
          extended: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: hugo --minify

      - name: Index with Pagefind
        run: npx pagefind --site public

      - name: Accessibility audit (pa11y-ci)
        run: |
          npm install -g pa11y-ci http-server
          # Start a local server in the background
          http-server public -p 8080 -s &
          SERVER_PID=$!
          # Wait for the server to start
          sleep 3
          # Run pa11y-ci against the built site
          pa11y-ci --config .pa11yci || true
          # Stop the server
          kill $SERVER_PID || true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./public

  # -------------------------------------------------------------------
  # 3. Deploy to GitHub Pages
  # -------------------------------------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # -------------------------------------------------------------------
  # 4. Pin to IPFS via Web3.Storage and update CID manifest
  # -------------------------------------------------------------------
  ipfs-pin:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ vars.ENABLE_IPFS_PIN != 'false' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Download built site
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: artifact

      - name: Extract Pages artifact
        run: |
          mkdir -p public
          tar -xf artifact/artifact.tar -C public

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install w3cli
        run: npm install -g @web3-storage/w3cli

      - name: Authenticate with Web3.Storage
        env:
          W3_STORE_NAME: ${{ secrets.W3_STORE_NAME }}
          W3_PRINCIPAL: ${{ secrets.W3_PRINCIPAL }}
        run: |
          # Authenticate using the delegation proof stored as a secret
          echo "${{ secrets.W3_STORAGE_TOKEN }}" | base64 -d > /tmp/w3-proof.ucan
          w3 space add /tmp/w3-proof.ucan
          rm /tmp/w3-proof.ucan

      - name: Upload to IPFS and capture CID
        id: ipfs_upload
        run: |
          echo "Uploading public/ directory to Web3.Storage..."
          CID=$(w3 up public/ --no-wrap 2>&1 | grep -oP 'bafy\w+' | tail -1)
          echo "Root CID: $CID"
          echo "cid=$CID" >> "$GITHUB_OUTPUT"

      - name: Update CID manifest
        run: |
          CID="${{ steps.ipfs_upload.outputs.cid }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Read current manifest or create one
          if [ -f ipfs-manifest.json ]; then
            MANIFEST=$(cat ipfs-manifest.json)
          else
            MANIFEST='{"rootCID":"","lastUpdated":"","history":[]}'
          fi

          # Update manifest using Node.js for safe JSON manipulation
          node -e "
            const fs = require('fs');
            const m = JSON.parse(process.argv[1]);
            const oldCID = m.rootCID;
            m.rootCID = process.argv[2];
            m.lastUpdated = process.argv[3];
            if (oldCID) {
              m.history.unshift({ cid: oldCID, date: m.lastUpdated });
            }
            // Keep last 20 entries
            m.history = m.history.slice(0, 20);
            fs.writeFileSync('ipfs-manifest.json', JSON.stringify(m, null, 2) + '\n');
          " "$MANIFEST" "$CID" "$TIMESTAMP"

          echo "Updated ipfs-manifest.json with CID: $CID"
          cat ipfs-manifest.json

      - name: Commit CID manifest
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ipfs-manifest.json
          # Only commit if there are changes
          git diff --cached --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update IPFS CID manifest [skip ci]"
          git push
